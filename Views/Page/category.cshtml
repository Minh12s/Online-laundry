@{
    Layout = "~/Views/Shared/User_Layout.cshtml";
    ViewData["Title"] = "Category";
}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
<style>
    .sidebar__item {
        margin-bottom: 35px;
    }

        .sidebar__item.sidebar__item__color--option {
            overflow: hidden;
        }

        .sidebar__item h4 {
            color: #1c1c1c;
            /*            font-weight: 700;*/
            margin-bottom: 25px;
        }

        .sidebar__item ul li {
            list-style: none;
        }

            .sidebar__item ul li a {
                font-size: 16px;
                color: #1c1c1c;
                line-height: 39px;
                display: block;
            }

        .sidebar__item .latest-product__text {
            position: relative;
        }

            .sidebar__item .latest-product__text h4 {
                margin-bottom: 45px;
            }

            .sidebar__item .latest-product__text .owl-carousel .owl-nav {
                right: 0;
            }

    .price-range-wrap .range-slider {
        margin-top: 20px;
    }

        .price-range-wrap .range-slider .price-input {
            position: relative;
        }

            .price-range-wrap .range-slider .price-input:after {
                position: absolute;
                left: 38px;
                top: 13px;
                height: 1px;
                width: 5px;
                background: #FFA45C;
                content: "";
            }

            .price-range-wrap .range-slider .price-input input {
                font-size: 16px;
                color: #FFA45C;
                font-weight: 700;
                max-width: 40%;
                border: none;
                display: inline-block;
            }

    .price-range-wrap .price-range {
        border-radius: 0;
    }

        .price-range-wrap .price-range.ui-widget-content {
            border: none;
            background: #ebebeb;
            height: 5px;
        }

            .price-range-wrap .price-range.ui-widget-content .ui-slider-handle {
                height: 13px;
                width: 13px;
                border-radius: 50%;
                background: #ffffff;
                border: none;
                -webkit-box-shadow: 0px 1px 10px rgba(0, 0, 0, 0.2);
                box-shadow: 0px 1px 10px rgba(0, 0, 0, 0.2);
                outline: none;
                cursor: pointer;
            }

        .price-range-wrap .price-range .ui-slider-range {
            background: #FFA45C;
            border-radius: 0;
        }

            .price-range-wrap .price-range .ui-slider-range.ui-corner-all.ui-widget-header:last-child {
                background: #FFA45C;
            }

    .sidebar__item__color {
        float: left;
        width: 40%;
    }

        .sidebar__item__color.sidebar__item__color--white label:after {
            border: 2px solid #333333;
            background: transparent;
        }

        .sidebar__item__color.sidebar__item__color--gray label:after {
            background: #E9A625;
        }

        .sidebar__item__color.sidebar__item__color--red label:after {
            background: #D62D2D;
        }

        .sidebar__item__color.sidebar__item__color--black label:after {
            background: #252525;
        }

        .sidebar__item__color.sidebar__item__color--blue label:after {
            background: #249BC8;
        }

        .sidebar__item__color.sidebar__item__color--green label:after {
            background: #3CC032;
        }

        .sidebar__item__color label {
            font-size: 16px;
            color: #333333;
            position: relative;
            padding-left: 32px;
            cursor: pointer;
        }

            .sidebar__item__color label input {
                position: absolute;
                visibility: hidden;
            }

            .sidebar__item__color label:after {
                position: absolute;
                left: 0;
                top: 5px;
                height: 14px;
                width: 14px;
                background: #222;
                content: "";
                border-radius: 50%;
            }

    .sidebar__item__size {
        display: inline-block;
        margin-right: 16px;
        margin-bottom: 10px;
    }

        .sidebar__item__size label {
            font-size: 12px;
            color: #6f6f6f;
            display: inline-block;
            padding: 8px 25px 6px;
            background: #f5f5f5;
            cursor: pointer;
            margin-bottom: 0;
        }

            .sidebar__item__size label input {
                position: absolute;
                visibility: hidden;
            }
</style>
<div class="hero-wrap hero-bread" style="background-image: url('/images/anhbg1.jpg');">
    <div class="container">
        <div class="row no-gutters slider-text align-items-center justify-content-center">
            <div class="col-md-9 ftco-animate text-center">
                <p class="breadcrumbs"><span class="mr-2"><a href="index.html">Home</a></span> <span>Products</span></p>
                <h1 class="mb-0 bread">Collection Products</h1>
            </div>
        </div>
    </div>
</div>

<section class="ftco-section bg-light">
    <div class="container">
        <div class="row">
            <div class="col-md-8 col-lg-10 order-md-last">
                <div class="row">
                    @if (Model.Count > 0)
                    {
                        @foreach (var product in Model)
                        {
                            <div class="col-sm-6 col-md-6 col-lg-4 ftco-animate">
                                <div class="product">
                                    <a href="#" class="img-prod">
                                        <img class="img-fluid" src="@product.Thumbnail" alt="Colorlib Template">
                                        <span class="status">30%</span>
                                        <div class="overlay"></div>
                                    </a>
                                    <div class="text py-3 px-3">
                                        <h3><a href="@Url.Action("Details", "Page", new { slug = product.Slug })">@product.ProductName</a></h3>

                                        <div class="d-flex">
                                            <div class="pricing">
                                                <p class="price"><span class="mr-2 price-dc">$120.00</span><span class="price-sale">$@product.Price</span></p>
                                            </div>
                                            <div class="rating">
                                                <p class="text-right">
                                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                </p>
                                            </div>
                                        </div>
                                        <p class="bottom-area d-flex px-3">
                                            <a href="#" class="add-to-cart text-center py-2 mr-1"><span>Add to cart <i class="ion-ios-add ml-1"></i></span></a>
                                            <a href="#" class="buy-now text-center py-2">Buy now<span><i class="ion-ios-cart ml-1"></i></span></a>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="col-md-12 text-center">
                            <p>No products found matching the selected criteria.</p>
                        </div>
                    }
                </div>
                <div class="row mt-5">
                    <div class="col text-center">
                        <div class="block-27">
                            <ul>
                                <li>
                                    @if (Model.Count > 0)
                                    {
                                        for (int i = 1; i <= ViewBag.TotalPages; i++)
                                        {
                                            <a href="@Url.Action("Category", new { slug = ViewBag.CategorySlug, page = i, minPrice = ViewBag.MinPrice, maxPrice = ViewBag.MaxPrice, brandId = ViewBag.BrandId, goldAgeId = ViewBag.GoldAgeId })">@i</a>
                                        }
                                    }
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

            </div>

            <div class="col-md-4 col-lg-2 sidebar">
                <div class="sidebar-box-2">
                    <h2 class="heading mb-4"><a href="#">Category</a></h2>
                    <ul>
                        @foreach (var category in ViewBag.Categories)
                        {
                            <li><a asp-controller="Page" asp-action="Shop" asp-route-slug="@category.Slug">@category.CategoryName</a></li>
                        }
                    </ul>
                </div>
                <form id="filterForm" action="@Url.Action("Category", "Page")" method="get">
                    <div class="sidebar-box-2">
                        <div class="sidebar__item">
                            <h4>Price</h4>
                            <div class="price-range-wrap">
                                <div class="price-range ui-slider ui-corner-all ui-slider-horizontal ui-widget ui-widget-content"
                                     data-min="100" data-max="1000">
                                    <div class="ui-slider-range ui-corner-all ui-widget-header"></div>
                                    <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                                    <span tabindex="0" class="ui-slider-handle ui-corner-all ui-state-default"></span>
                                </div>
                                <div class="range-slider">
                                    <div class="price-input">
                                        <input type="text" id="minamount">
                                        <input type="text" id="maxamount">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="sidebar-box-2">
                        <h2 class="heading mb-4"><a href="#">Gold Age</a></h2>
                        <ul>
                            @foreach (var goldAge in ViewBag.GoldAges as List<GoldAge>)
                            {
                                <li>
                                    <input type="checkbox" id="@goldAge.GoldAgeId" name="goldAgeId" value="@goldAge.GoldAgeId">
                                    <label style="margin-left:5px;" for="@goldAge.GoldAgeId">@goldAge.Age</label>
                                </li>
                            }
                        </ul>
                    </div>

                    <div class="sidebar-box-2">
                        <h2 class="heading mb-4"><a href="#">Brand</a></h2>
                        <ul>
                            @foreach (var brand in ViewBag.Brands as List<Brand>)
                            {
                                <li>
                                    <input type="checkbox" id="@brand.BrandId" name="brandId" value="@brand.BrandId">
                                    <label style="margin-left:5px;" for="@brand.BrandId">@brand.BrandName</label>
                                </li>
                            }
                        </ul>
                    </div>
                </form>

            </div>
        </div>
    </div>
</section>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
<script>
    var minPriceParam, maxPriceParam; // Biến toàn cục để lưu trữ giá trị phạm vi giá

    document.addEventListener("DOMContentLoaded", function () {
        var filterForm = document.getElementById("filterForm");
        var inputs = filterForm.querySelectorAll("input[type='text'], input[type='checkbox']");

        var urlParams = new URLSearchParams(window.location.search);
        inputs.forEach(function (input) {
            var paramName = input.getAttribute("name");
            if (urlParams.has(paramName)) {
                if (input.type === "checkbox") {
                    var paramValue = urlParams.getAll(paramName);
                    if (paramValue.includes(input.value)) {
                        input.checked = true;
                    }
                } else {
                    input.value = urlParams.get(paramName);
                }
            }
        });

        minPriceParam = urlParams.get('minPrice');
        maxPriceParam = urlParams.get('maxPrice');
        if (minPriceParam && maxPriceParam) {
            rangeSlider.slider("values", [parseInt(minPriceParam), parseInt(maxPriceParam)]);
            minamount.val('$' + minPriceParam);
            maxamount.val('$' + maxPriceParam);
        }

        inputs.forEach(function (input) {
            input.addEventListener("change", function () {
                updateUrl();
            });
        });

        // Gọi hàm updateUrl() khi thanh trượt giá thay đổi
        rangeSlider.on("slidechange", function () {
            updateUrl();
        });
    });

    var rangeSlider = $(".price-range"),
        minamount = $("#minamount"),
        maxamount = $("#maxamount"),
        minPrice = rangeSlider.data('min'),
        maxPrice = rangeSlider.data('max');

    rangeSlider.slider({
        range: true,
        min: minPrice,
        max: maxPrice,
        values: [minPrice, maxPrice],
        slide: function (event, ui) {
            minamount.val('$' + ui.values[0]);
            maxamount.val('$' + ui.values[1]);
        }
    });

    minamount.val('$' + rangeSlider.slider("values", 0));
    maxamount.val('$' + rangeSlider.slider("values", 1));

    function updateUrl() {
        var filterForm = document.getElementById("filterForm");
        var inputs = filterForm.querySelectorAll("input[type='text'], input[type='checkbox']");

        var goldAgeIds = [];
        $("input[name='goldAgeId']:checked").each(function () {
            goldAgeIds.push($(this).val());
        });

        var brandIds = [];
        $("input[name='brandId']:checked").each(function () {
            brandIds.push($(this).val());
        });

        var currentMinPrice = rangeSlider.slider("values", 0);
        var currentMaxPrice = rangeSlider.slider("values", 1);

        var url = '@Url.Action("Category", "Page")' + '?minPrice=' + currentMinPrice + '&maxPrice=' + currentMaxPrice;

        if (goldAgeIds.length > 0) {
url += '&goldAgeId=' + goldAgeIds.join(',');
        }

        if (brandIds.length > 0) {
            url += '&brandId=' + brandIds.join(',');
        }

        window.location.href = url;
    }


</script>
